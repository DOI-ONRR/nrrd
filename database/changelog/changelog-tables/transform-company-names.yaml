databaseChangeLog:
  - changeSet:
      id: 000-create-uuid-ossp-extension
      author: Jeff Schwartz
      changes:
        - sql:
            splitStatements: false
            sql: CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

  - changeSet:
      id: 001-create-transform-company-names-table
      author: Jeff Schwartz
      changes:
        - createTable:
            tableName: transform_company_names
            columns:
              - column:
                  name: id
                  type: UUID
                  defaultValueComputed: uuid_generate_v4()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: original_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: new_name
                  type: VARCHAR(255)
                  constraints:
                    nullable: false

  - changeSet:
      id: 002-load-transform-company-names-data
      author: Jeff Schwartz
      changes:
        - loadData:
            tableName: transform_company_names
            file: '../static/csv/transform-company-names.csv'
            separator: ","
            encoding: UTF-8
            quotchar: '"'
            columns:
              - column:
                  name: original_name
                  index: 0
              - column:
                  name: new_name
                  index: 1

  - changeSet:
      id: 003-update-federal-revenue-company-names
      author: Jeff Schwartz
      changes:
        - sql:
            splitStatements: false
            stripComments: false
            sql: |
              DO $$
              DECLARE
                  rec RECORD;
              BEGIN
                  FOR rec IN SELECT original_name, new_name FROM transform_company_names
                  LOOP
                      UPDATE federal_revenue_by_company
                      SET corporate_name = rec.new_name
                      WHERE corporate_name = rec.original_name;
                  END LOOP;
              END;
              $$;